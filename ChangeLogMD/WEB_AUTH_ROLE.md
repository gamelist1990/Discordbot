# WEB認証ロール機能の実装

## 概要
Discord Bot のWEB認証時にユーザーに特定のロールを自動的に付与し、ログアウト時にそのロールを削除する機能を実装しました。

## 実装の詳細

### 1. **GuildSettings型の拡張** (`src/web/types/index.ts`)
- `webAuthRoleId?: string;` フィールドを追加
- サーバーごとにWEB認証用のロールIDを設定可能

### 2. **SettingsController の拡張** (`src/web/controllers/SettingsController.ts`)
- `getSettings`: 既存の設定とともに `webAuthRoleId` も返す
- `saveSettings`: `webAuthRoleId` の保存に対応

### 3. **OAuth2認証後のロール付与** (`src/web/routes/auth.ts`)
**callback エンドポイント内での処理:**
- 認証成功後、各ギルドの設定から `webAuthRoleId` を取得
- ユーザーがギルドのメンバーであることを確認
- メンバーにロールを追加
- エラーハンドリング：ロール付与失敗は認証を失敗させない

### 4. **ログアウト時のロール削除** (`src/web/routes/auth.ts`)
**logout エンドポイント:**
- セッション削除前にユーザーの `guildIds` を取得
- 各ギルドから設定を読み込み、`webAuthRoleId` を確認
- メンバーからロールを削除
- エラーハンドリング：ロール削除失敗はログアウトを失敗させない

### 5. **セッション期限切れ時のロール削除** (`src/web/services/SessionService.ts`)
**cleanupExpiredSessions メソッドの拡張:**
- `removeWebAuthRolesFromSession()` プライベートメソッドを追加
- 期限切れセッションのクリーンアップ時に自動的にロール削除
- BotClient をコンストラクタで受け取るように修正

### 6. **SettingsServer の修正** (`src/web/SettingsServer.ts`)
- SessionService のコンストラクタに `botClient` を渡すように修正

## フロー図

```
WEB認証時:
1. ユーザーがOAuth2認証を開始
2. Discord OAuth2サーバーで認証
3. callback エンドポイントで:
   - ユーザー情報とギルドを取得
   - 各ギルドの webAuthRoleId を確認
   - ロール付与処理を実行
   - セッションを作成
4. ユーザーがロール付与されたまま認証完了

ログアウト時:
1. ユーザーがログアウトをクリック
2. logout エンドポイント:
   - セッションからギルドIDのリストを取得
   - 各ギルドのロールを削除
   - セッションを削除

セッション期限切れ時:
1. 定期的なクリーンアップ処理が実行
2. 期限切れセッションから:
   - ギルドIDのリストを取得
   - 各ギルドのロールを削除
   - セッションを削除
```

## 管理画面での使用方法

### ロール設定
1. サーバーの設定画面へアクセス
2. 「WEB認証ロール」フィールドにロールIDを入力
3. 設定を保存

### API リクエスト例

**ロール設定の保存:**
```bash
POST /api/settings/{guildId}
Content-Type: application/json

{
  "staffRoleId": "123456789",
  "webAuthRoleId": "987654321"
}
```

**ロール設定の取得:**
```bash
GET /api/settings/{guildId}
```

## エラーハンドリング

- ロール付与/削除に失敗した場合、ユーザーにはエラーを返さない（サイレント処理）
- コンソールにはエラーログを出力する
- 認証やログアウトの成功は保証される

## ロールの永続性

- WEB認証ロールはメンバーのロール一覧に記録される
- Discord のロール管理システムを使用するため、ロール情報は Discord 側に保存される
- セッション削除時のみロール削除が実行される

## セキュリティ考慮事項

1. **権限チェック**: ロール設定は権限レベル1以上のユーザーのみ可能
2. **エラー対応**: ロール操作のエラーがシステムの不安定化につながらない設計
3. **非同期処理**: ロール付与/削除は非ブロッキングで実行

## 今後の改善案

1. ロール付与/削除の履歴ログを記録
2. ロール付与に失敗した場合のリトライ機能
3. 複数のロール設定（複数のロール同時付与）
4. ロール付与の自動解除タイマー設定
