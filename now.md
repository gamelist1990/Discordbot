# 🤖 現状のシステム構成

## 概要

このリポジトリは、多機能な **Discord ボット** と、その設定を管理するための **Web ダッシュボード** で構成されています。
**TypeScript** を主言語とし、バックエンドは **Node.js** と **discord.js**、フロントエンドは **React** と **Vite** で構築されています。

---

## ✨ 主要な機能

- **🌐 Web ダッシュボード**:
    - ボットの各種設定をブラウザからリアルタイムで変更可能。
    - サーバー設定、権限管理、機能の有効/無効化など。
- **🏆 ランキングシステム**:
    - メンバーの活動（発言や VC 参加）に応じて XP を付与し、ランキング化。
    - ランクに応じたロール報酬の設定が可能。
- **🔄 トリガー機能**:
    - 特定のキーワードに反応して自動応答するカスタムコマンドを作成可能。
- **🧠 AI ツール連携**:
    - OpenAI API と連携し、高度な対話機能を提供。
- **📝 TODO 管理**:
    - ユーザーごとの TODO リスト管理機能。
- **🛡️ スタッフ用プライベートチャット**:
    - モデレーターや管理者向けのプライベートなチャット機能。

---

## 🛠️ 技術スタック

| カテゴリ     | 技術                                |
| :----------- | :---------------------------------- |
| **バックエンド** | `TypeScript`, `Node.js`, `discord.js`, `Express` |
| **フロントエンド** | `TypeScript`, `React`, `Vite`       |
| **データベース** | `SQLite`                            |
| **パッケージ管理**| `Bun`                               |


> **Note:** データベースは `src/core/Database.ts` を見る限り、SQLite を使用しているようです。

---

## 📂 プロジェクト構造

以下に、主要なディレクトリとファイルの概要を記します。

- **`.github/`**: GitHub 関連の設定ファイル。
    - `workflows/`: GitHub Actions のワークフロー定義ファイル（CI/CD、コードレビューなど）。
- **`ChangeLogMD/`**: プロジェクトの変更履歴や実装に関するメモ。
- **`docs/`**: 各機能に関する詳細なドキュメント。
- **`src/`**: 全てのソースコードが含まれるメインディレクトリ。
    - **`commands/`**: Discord のスラッシュコマンド定義。
        - `admin/`: サーバー管理者向けコマンド。
        - `any/`: 全ユーザーが利用できるコマンド。
        - `staff/`: スタッフ（モデレーター）向けコマンド。
    - **`core/`**: ボットの根幹をなすコア機能のクラス群。
        - `BotClient.ts`: Discord クライアントの初期化と管理。
        - `CommandLoader.ts`: `commands` ディレクトリからコマンドを動的に読み込み。
        - `Database.ts`: SQLite データベースの接続と操作を管理。
        - `EventHandler.ts`, `EventManager.ts`: Discord API のイベントを処理。
        - `RankManager.ts`, `TriggerManager.ts` など: 各機能の主要ロジックを管理。
    - **`types/`**: TypeScript の型定義。
    - **`utils/`**: 汎用的な補助機能（ロガー、キャッシュ管理など）。
    - **`web/`**: Web ダッシュボードのバックエンド (`Express`) とフロントエンド (`React`)。
        - `client/`: React で構築されたフロントエンドのソースコード。
        - `controllers/`: API リクエストを処理するロジック。
        - `middleware/`: 認証などのミドルウェア。
        - `routes/`: Express のルーティング定義。
        - `SettingsServer.ts`: Express サーバーのメインファイル。
- **`test/`**: テストコード。
    - `playwright/`: Playwright を使用した E2E テスト。

- `bun.lock`: パッケージのバージョンをロックするファイル。
- `package.json`: プロジェクトの情報と依存関係を定義。
- `tsconfig.json`: TypeScript のコンパイラ設定。

---

## 🚀 起動プロセス

1.  **`src/index.ts`** がエントリーポイント。
2.  `config.json` を読み込む。
3.  `BotClient` を初期化し、Discord にログイン。
4.  データベースを初期化。
5.  `CommandLoader` で `src/commands/` 以下のコマンドを読み込み。
6.  `EventHandler` で Discord のイベントリスナーを登録。
7.  各機能マネージャー (`RankManager`, `TriggerManager` など) を初期化。
8.  `deployCommandsToAllGuilds()` でコマンドを全サーバーにデプロイ。
9.  `src/web/SettingsServer.ts` の `SettingsServer` を起動し、Web ダッシュボード用のサーバーを開始。

---

## 📈 今後の課題・改善点（レビュー）

- **設定ファイルの管理**:
    - `config.json` を手動で作成する必要があり、環境変数のサポートもない。
    - **提案**: `.env` ファイルのサポートを追加する。
- **エラーハンドリング**:
    - `unhandledRejection` や `uncaughtException` でプロセスを終了させている。
    - **提案**: より詳細なエラーログの収集や、プロセスの再起動など、堅牢性を高める仕組みを導入する。
- **フロントエンドの状態管理**:
    - 状態管理ライブラリ（Redux, Zustand など）が導入されていない。
    - **提案**: コンポーネント間の状態共有が複雑化する前に、導入を検討する。
- **テストカバレッジ**:
    - 単体テストや結合テストが不足している。
    - **提案**: 機能追加やリファクタリングの安全性を高めるため、テストコードを導入する。
- **WebSocket の責務**:
    - WebSocket サーバーがフィードバック機能に特化している (`/ws/feedback`)。
    - **提案**: より汎用的な設計に見直し、他機能（例: ログのリアルタイム表示）にも活用できるようにする。

---
以上が、現状のシステム構成と簡単なレビューです。
