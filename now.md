# 現状のシステム構成

## 概要

このリポジトリは、多機能なDiscordボットと、その設定を管理するためのWebダッシュボードで構成されています。TypeScriptを主言語とし、バックエンドはNode.jsとdiscord.js、フロントエンドはReactとViteで構築されています。

## 主要な機能

- **Webダッシュボード**:
    - ボットの各種設定をブラウザからリアルタイムで変更可能。
    - サーバー設定、権限管理、機能の有効/無効化など。
- **ランキングシステム**:
    - メンバーの活動（発言やVC参加）に応じてXPを付与し、ランキング化。
    - ランクに応じたロール報酬の設定が可能。
- **トリガー機能**:
    - 特定のキーワードに反応して自動応答するカスタムコマンドを作成可能。
- **AIツール連携**:
    - OpenAI APIと連携し、高度な対話機能を提供。
- **TODO管理**:
    - ユーザーごとのTODOリスト管理機能。
- **スタッフ用プライベートチャット**:
    - モデレーターや管理者向けのプライベートなチャット機能。

## 技術スタック

- **バックエンド**:
    - **言語**: TypeScript
    - **ランタイム**: Node.js
    - **フレームワーク**: discord.js, Express
    - **パッケージマネージャ**: Bun
- **フロントエンド**:
    - **言語**: TypeScript
    - **フレームワーク**: React
    - **ビルドツール**: Vite
- **データベース**:
    - `src/core/Database.ts`を見ると、SQLiteを使用しているようです。

## プロジェクト構造

以下に、主要なディレクトリとファイルの概要を記します。

- **`.github/`**: GitHub関連の設定ファイルが格納されています。
    - `workflows/`: GitHub Actionsのワークフロー定義ファイル（例: CI/CD、コードレビュー）。
- **`ChangeLogMD/`**: プロジェクトの変更履歴や実装に関するメモが格納されています。
- **`docs/`**: 各機能に関する詳細なドキュメントが格納されています。
- **`src/`**: 全てのソースコードが含まれるメインディレクトリです。
    - **`commands/`**: Discordのスラッシュコマンドの定義が格納されています。
        - `admin/`: サーバー管理者向けのコマンド。
        - `any/`: 全てのユーザーが利用できるコマンド。
        - `staff/`: スタッフ（モデレーター）向けのコマンド。
            - `subcommands/`: スタッフコマンドのサブコマンド。
    - **`core/`**: ボットの根幹をなすコア機能のクラス群です。
        - `BotClient.ts`: Discordクライアントの初期化と管理。
        - `CommandLoader.ts`: `commands`ディレクトリからコマンドを動的に読み込みます。
        - `CommandRegistry.ts`: 読み込んだコマンドを登録・管理します。
        - `Database.ts`: SQLiteデータベースの接続と操作を管理します。
        - `EventHandler.ts`, `EventManager.ts`: Discord APIから送られるイベントを処理します。
        - `RankManager.ts`, `TriggerManager.ts`など: 各機能の主要なロジックを管理するクラス。
    - **`types/`**: プロジェクト全体で使用されるTypeScriptの型定義です。
    - **`utils/`**: 汎用的な補助機能（ロガー、キャッシュ管理など）が格納されています。
    - **`web/`**: Webダッシュボードのバックエンド（Express）とフロントエンド（React）のソースコードです。
        - `assets/`: アイコンなどの静的ファイル。
        - `client/`: Reactで構築されたフロントエンドのソースコード。
            - `src/`:
                - `components/`: 再利用可能なReactコンポーネント。
                - `hooks/`: カスタムReactフック。
                - `pages/`: 各URLに対応するページコンポーネント。
                - `services/`: APIクライアントやWebSocket接続などのサービス。
                - `styles/`: グローバルCSSやコンポーネント固有のスタイルシート。
        - `controllers/`: APIリクエストを処理し、レスポンスを返すロジック。
        - `middleware/`: 認証など、リクエスト処理の中間で実行される処理。
        - `routes/`: Expressのルーティング定義。
        - `services/`: Webサーバー固有のサービスロジック。
        - `SettingsServer.ts`: Expressサーバーを起動し、APIとフロントエンドを提供するメインファイル。
- **`test/`**: テストコードが格納されています。
    - `playwright/`: Playwrightを使用したE2Eテスト。

- **`bun.lock`**: パッケージの正確なバージョンをロックするファイル。
- **`package.json`**: プロジェクトの情報と依存関係を定義するファイル。
- **`tsconfig.json`**: TypeScriptのコンパイラ設定。

## 起動プロセス

1.  **`src/index.ts`** がエントリーポイント。
2.  `config.json` を読み込む。
3.  `BotClient` を初期化し、Discordにログイン。
4.  データベースを初期化。
5.  `CommandLoader` を使って `src/commands/` 以下のコマンドをすべて読み込む。
6.  `EventHandler` を使ってDiscordのイベント（メッセージ受信など）のリスナーを登録。
7.  `RankManager`, `StatsManager`, `TriggerManager` などの各機能マネージャーを初期化。
8.  `deployCommandsToAllGuilds()` を呼び出し、登録されたコマンドを全サーバーにデプロイ。
9.  **`src/web/SettingsServer.ts`** の `SettingsServer` を起動し、Webダッシュボード用のAPIサーバーと静的ファイル配信を開始。

## 今後の課題・改善点（レビュー）

- **設定ファイルの管理**:
    - 現在、`config.json` を手動で作成する必要があり、環境変数のサポートもないため、デプロイ環境によっては不便な場合があります。`.env` ファイルのサポートを追加することが望ましいです。
- **エラーハンドリング**:
    - `src/index.ts` の `unhandledRejection` や `uncaughtException` でプロセスを終了させていますが、より詳細なエラーログの収集や、可能な場合はプロセスの再起動などの堅牢性を高める仕組みが考えられます。
- **フロントエンドの状態管理**:
    - フロントエンドでは、状態管理ライブラリ（Redux, Zustandなど）が導入されておらず、コンポーネント間の状態の受け渡しが複雑になる可能性があります。
- **コンポーネントのテスト**:
    - フロントエンド・バックエンド共に、単体テストや結合テストが不足しています。機能追加やリファクタリングを安全に行うために、テストコードの導入が推奨されます。
- **WebSocketの責務**:
    - `SettingsServer.ts` でWebSocketサーバーが起動されていますが、フィードバック機能に特化しているように見えます（`/ws/feedback`）。より汎用的なリアルタイム通信基盤として設計し直すことで、他の機能（例: ログのリアルタイム表示など）にも活用できる可能性があります。

以上が、現状のシステム構成と簡単なレビューです。
